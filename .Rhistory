model.random.adj <- glmer(type == "S" ~ strike_prob + (1|catcher),
family = "binomial",
data = taken)
summary(model.random.adj)
# random effects
model.random.adj %>% tidy(effects = "ran_pers")
library(broom)
# random effects
model.random.adj %>% tidy(effects = "ran_pers")
# random effects
model.random.adj %>% tidy(effects = "ran_pars")
# fixed effects
model.random.adj %>% tidy(effects = "fixed")
#get random effects
model.random.adj %>%
ranef() %>%
as_tibble() %>%
transmute(id = levels(grp),
effect = condval) %>%
arrange(desc(effect)) -> catcher_effects.adj
catcher_effects.adj %>% head(5)
catcher_effects.adj %>% tail(5)
catcher_effects.adj %>%
ggplot(aes(x = effect)) +
geom_dotplot()
library(ggrepel)
catcher_effects.adj %>%
ggplot(aes(x = effect)) +
geom_dotplot() +
geom_text_repel(data = filter(catcher_effects.adj, abs(effect) > 0.3), aes(label = id))
catcher_effects.adj %>%
ggplot(aes(x = effect)) +
geom_dotplot() +
geom_text_repel(data = filter(catcher_effects.adj, abs(effect) > 0.3), aes(y = effect, label = id))
catcher_effects.adj %>%
ggplot(aes(x = effect)) +
geom_dotplot() +
geom_text_repel(data = filter(catcher_effects.adj, abs(effect) > 0.3), aes(x = effect, label = id))
catcher_effects.adj %>%
ggplot(aes(x = effect)) +
geom_dotplot() +
geom_text_repel(data = filter(catcher_effects.adj, abs(effect) > 0.3), aes(x = effect, y = 1, label = id))
catcher_effects.adj %>%
ggplot(aes(x = effect)) +
geom_dotplot() +
geom_text_repel(data = filter(catcher_effects.adj, abs(effect) > 0.3), aes(x = effect, y = 0.25, label = id))
catcher_effects.adj %>%
ggplot(aes(x = effect, label = id)) +
geom_dotplot() +
geom_text_repel(data = filter(catcher_effects.adj, abs(effect) > 0.3))
catcher_effects.adj %>%
ggplot(aes(x = effect, label = id)) +
geom_dotplot() +
geom_text_repel(data = filter(catcher_effects.adj, abs(effect) > 0.3), aes(y = effect))
catcher_effects.adj %>%
ggplot(aes(x = effect, label = id)) +
geom_dotplot()
taken$pitcher
#fit random effects model adjusting for pitch location and pitcher
model.random.adj2 <- glmer(type == "S" ~ strike_prob + (1|catcher) + (1|pitcher),
family = "binomial",
data = taken)
# random effects
model.random.adj2 %>% tidy(effects = "ran_pars")
# fixed effects
model.random.adj2 %>% tidy(effects = "fixed")
#get random effects
model.random.adj %>%
ranef() %>%
as_tibble() %>%
transmute(id = levels(grp),
effect = condval) %>%
arrange(desc(effect)) -> catcher_effects.adj
catcher_effects.adj %>% head(5)
catcher_effects.adj %>% tail(5)
catcher_effects.adj %>%
ggplot(aes(x = effect, label = id)) +
geom_dotplot()
# random effects
model.random.adj2 %>% tidy(effects = "ran_pars")
# fixed effects
model.random.adj2 %>% tidy(effects = "fixed")
#get random effects
model.random.adj2 %>%
ranef() %>%
as_tibble() %>%
transmute(id = levels(grp),
effect = condval) %>%
arrange(desc(effect)) -> catcher_effects.adj2
catcher_effects.adj2 %>% head(5)
catcher_effects.adj2 %>% tail(5)
#get random effects
model.random.adj2 %>%
ranef() %>%
as_tibble() %>%
filter(grpvar == "catcher") %>%
transmute(id = levels(grp),
effect = condval) %>%
arrange(desc(effect)) -> catcher_effects.adj2
model.random.adj2 %>%
ranef() %>%
as_tibble()
model.random.adj2 %>%
ranef() %>%
as_tibble() %>%
filter(grpvar == "catcher")
#get random effects
model.random.adj2 %>%
ranef() %>%
as_tibble() %>%
filter(grpvar == "catcher") %>%
transmute(id = grp,
effect = condval) %>%
arrange(desc(effect)) -> catcher_effects.adj2
catcher_effects.adj2 %>% head(5)
catcher_effects.adj2 %>% tail(5)
catcher_effects.adj2 %>%
ggplot(aes(x = effect, label = id)) +
geom_dotplot()
12*5*52
library(Lahman)
library(tidyverse)
Master %>% filter(nameLast == "Jeter") %>% pull(playerID)
jeter.id = "jeterde01"
source("Chapter8_functions.R")
get_stats(jeter.id)
names(Batting)
source("Chapter8_functions.R")
jeter.id = "jeterde01"
get_stats(jeter.id)
install.packages("brms")
names(Master)
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthyear == 1974) %>%
left_join(Batting, by = "PlayerID") %>%
filter(AB >= 1000) -> players1974
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "PlayerID") %>%
filter(AB >= 1000) -> players1974
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "playerID") %>%
filter(AB >= 1000) -> players1974
Master %>%
filter(birthYear == 1974)
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "playerID")
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "playerID") %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB >= 1000) -> players1974
players1974
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "playerID") %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB >= 1000) %>%
pull(playerID)-> players1974
players1974
players1974 %>%
map_df(get_stats)
players1974 %>%
map_df(get_stats) -> players.stats
players.stats
library(brms)
players.stats %>%
mutate(AgeD = Age - 30) -> players.stats
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | playerID),
data = players.stats,
family = binomial("logit"))
install.packages('rstan')
install.packages("rstan")
library(Lahman)
library(tidyverse)
library(brms)
library(rstan)
source("Chapter8_functions.R")
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "playerID") %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB >= 1000) %>%
pull(playerID)-> players1974
players1974 %>%
map_df(get_stats) -> players.stats
players.stats %>%
mutate(AgeD = Age - 30) -> players.stats
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | playerID),
data = players.stats,
family = binomial("logit"))
library(devtools)
library(devtools)
find_rtools()
library(Lahman)
library(tidyverse)
library(brms)
library(rstan)
library(devtools)
source("Chapter8_functions.R")
find_rtools()
rtools_path()
install.packages(pkgbuild)
install.packages('pkgbuild')
install.packages("pkgbuild")
library(pkgbuild)
has_rtools()
rtools_path()
find_rtools()
has_rtools()
rtools_path()
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | playerID),
data = players.stats,
family = binomial("logit"))
library(Lahman)
library(tidyverse)
library(brms)
library(rstan)
library(devtools)
source("Chapter8_functions.R")
find_rtools()
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "playerID") %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB >= 1000) %>%
pull(playerID)-> players1974
players1974 %>%
map_df(get_stats) -> players.stats
players.stats %>%
mutate(AgeD = Age - 30) -> players.stats
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | playerID),
data = players.stats,
family = binomial("logit"))
find_rtools()
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | playerID),
data = players.stats,
family = binomial("logit"))
library(Lahman)
library(tidyverse)
library(brms)
library(rstan)
library(devtools)
source("Chapter8_functions.R")
find_rtools()
#players born in 1974 with at least 1000 at-bats
Master %>%
filter(birthYear == 1974) %>%
left_join(Batting, by = "playerID") %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB >= 1000) %>%
pull(playerID)-> players1974
players1974 %>%
map_df(get_stats) -> players.stats
players.stats %>%
mutate(AgeD = Age - 30) -> players.stats
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | playerID),
data = players.stats,
family = binomial("logit"))
vignette("brms")
vignette(package = "brms")
vignette("brms_overview")
summary(fit)
vignette("brms_multilevel")
conditional_effects(fit)
marginal_effects(fit)
conditional_effects(fit)
names(fit)
vignette("brms_nonlinear")
plot(fit)
fit$data
fit %>% select(data)
head(fit$data)
head(fit$data2)
names(fut)
names(fit)
fit$ranef
players1974 %>%
map_df(get_stats)  %>%
mutate(AgeD = Age - 30) -> players.stats
players1974 %>%
map_df(get_stats)  %>%
mutate(AgeD = Age - 30) %>%
left_join(Master %>% select(playerID, nameLast, nameFirst),
by = "playerID") %>%
mutate(Player = paste(nameFirst, nameLast, sep = " ")) -> players.stats
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | Player),
data = players.stats,
family = binomial("logit"))
coef(fit)
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as.data.frame()
Player_Fits
players.stats <- inner_join(players.stats, Player_Fits, by = "Player")
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as.tibble()
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as_tibble()
Player_Fits
coef(fit)$Player
coef(fit)$Player[, "Estimate", ]
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as_tibble(rownames = "Player")
Player_Fits
players.stats <- inner_join(players.stats, Player_Fits, by = "Player")
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as_tibble(rownames = "Player")
Player_Fits
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as_tibble(rownames = "Player") %>%
rename(Intercept = b0.hat,
AgeD = b1.hat,
IAgeDE2 = b2.hat)
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as_tibble(rownames = "Player") %>%
rename(b0.hat = Intercept,
b1.hat = AgeD,
b2.hat = IAgeDE2)
players1974 %>%
map_df(get_stats)  %>%
mutate(AgeD = Age - 30) %>%
left_join(Master %>% select(playerID, nameLast, nameFirst),
by = "playerID") %>%
mutate(Player = paste(nameFirst, nameLast, sep = " ")) -> player.stats
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as_tibble(rownames = "Player") %>%
rename(b0.hat = Intercept,
b1.hat = AgeD,
b2.hat = IAgeDE2)
player.stats <- inner_join(player.stats, Player_Fits, by = "Player")
player.stats
players1974 %>%
map_df(get_stats)  %>%
mutate(AgeD = Age - 30) %>%
left_join(Master %>% select(playerID, nameLast, nameFirst),
by = "playerID") %>%
mutate(Player = paste(nameFirst, nameLast, sep = " ")) %>%
select(-nameLast,-nameFirst) -> player.stats
player.stats <- inner_join(player.stats, Player_Fits, by = "Player")
View(player.stats)
mutate(OBP.pred = plogis(b0.hat + b1.hat * AgeD + b2.hat * AgeD^2) -> player.stats
)
# find estimates of OBP probs at each age
# note plogis is the logit function
player.stats %>%
mutate(OBP.pred = plogis(b0.hat + b1.hat * AgeD + b2.hat * AgeD^2)) -> player.stats
player.stats
player.stats %>%
ggplot(aes(x = Age + 30,
y = OBP.pred,
group = Player)) +
geom_line()
7293.58 + 3281.39
12*(254.39 + 3489.00 + 57.00)
450*22
library(tidyverse)
survey <- read_csv(file = "/Users/kfcummiskey/Downloads/MA388 Sabermetrics Survey(1-31) (1).csv")
View(survey)
survey %>%
separate(Name, into("First", "Last"), sep = " ") -> survey
survey %>%
separate(Name, into = c("First", "Last"), sep = " ") -> survey
cadets <- read_csv(file = "/Users/kfcummiskey/Downloads/MA388 Roster.csv")
cadets %>%
anti_join(survey, by = "Last")
View(cadets)
cadets %>%
mutate(Last = str_to_title(Last))
cadets %>%
mutate(Last = str_to_title(Last)) %>%
anti_join(survey, by = "Last")
cadets %>%
mutate(Last = str_to_title(Last)) %>%
anti_join(survey, by = "Last") %>%
pull(Last)
Batting %>%
filter(yearID == 2009) %>%
arrange(desc(HR))
library(Lahman)
Batting %>%
filter(yearID == 2009) %>%
arrange(desc(HR)) %>%
head(5)
Batting %>%
+ filter(yearID == 2009) %>%
+ arrange(desc(HR)) %>%
+ head(5)
Batting %>%
filter(yearID == 2009) %>%
arrange(desc(HR)) %>%
head(5)
Batting %>%
filter(yearID == 2010) %>%
arrange(desc(HR)) %>%
head(5)
Batting %>%
filter(yearID == 2005) %>%
arrange(desc(HR)) %>%
head(5)
library(tidyverse)
library(tidyverse)
library(Lahman)
#find Big Papi's playerID
Master %>%
filter(nameLast == "Ortiz", nameFirst == "David")
#find Big Papi's playerID
Master %>%
filter(nameLast == "Ortiz", nameFirst == "David") %>%
pull(playerID) -> ortiz.id
Batting %>%
filter(playedID == ortiz.id)
Batting %>%
filter(playerID == ortiz.id)
#use get_stats function (pg 180)
source("Chapter8_functions.R")
Ortiz <- get_stats(ortiz.id)
Ortiz
Batting %>%
filter(playerID == ortiz.id)
Ortiz %>%
ggplot(aes(x = Age, y = SLG)) +
geom_point() +
labs(title = "David Ortiz")
Ortiz %>%
ggplot(aes(x = Age, y = AVG)) +
geom_point() +
labs(title = "David Ortiz")
Ortiz %>%
ggplot(aes(x = Age, y = SLG)) +
geom_point() +
labs(title = "David Ortiz")
#function to return players Age, SLG, OBP, OPS
get_stats <- function(player.id){
require(Lahman)
Batting %>%
filter(playerID == player.id) %>%
inner_join(Master, by = "playerID") %>%
mutate(birthyear = ifelse(birthMonth >= 7,
birthYear + 1, birthYear),
Age = yearID - birthyear,
SLG = (H - X2B - X3B - HR +
2 * X2B + 3*X3B + 4 * HR)/AB,
OBP = (H + BB + HBP)/(AB + BB+ HBP + SF),
OPS = SLG + OBP,
AVG = H/AB,
HR.rate = HR/AB,
OB = (H + BB + HBP),
PA = (AB + BB + HBP + SF)) %>%
select(playerID, Age, yearID, SLG, OBP, OPS, AVG, HR.rate, OB, PA)
}
Ortiz <- get_stats(ortiz.id)
Ortiz
Batting %>%
group_by(playerID) %>%
summarize_at(vars, sum, na.rm = TRUE)
vars = c("H","AB")
Batting %>%
group_by(playerID) %>%
summarize_at(vars, sum, na.rm = TRUE) %>%
summarize(Career.AB = sum(AB, na.rm = TRUE)) %>%
filter(Career.AB >= 3200)
Batting %>%
group_by(playerID) %>%
summarize_at(vars, sum, na.rm = TRUE)
Batting %>%
group_by(playerID) %>%
summarize_at(vars, sum, na.rm = TRUE) %>%
filter(Career.AB >= 3200)
Batting %>%
group_by(playerID) %>%
summarize_at(vars, sum, na.rm = TRUE)
Batting %>%
group_by(playerID) %>%
summarize_at(vars, sum, na.rm = TRUE) %>%
filter(AB >= 3200)
model.ortiz <- fit_model(Ortiz)
model.ortiz
plot_trajectories(ortiz.id, n.similar = 1, ncol = 1)
plot_trajectories(ortiz.id, n.similar = 0, ncol = 1)
Ortiz %>%
ggplot(aes(x = Age, y = SLG)) +
geom_point() +
labs(title = "David Ortiz") +
geom_smooth(method = "lm",
model = y ~ x + I(x^2))
Ortiz %>%
ggplot(aes(x = Age, y = SLG)) +
geom_point() +
labs(title = "David Ortiz") +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2))
