library(Lahman)
library(tidyverse)
#Players with debut in year 2000
Master %>%
filter(year(debut) == 2000)
library(lubridate)
#Players with debut in year 2000
Master %>%
filter(year(debut) == 2000)
#Players with debut in year 2000
Master %>%
filter(year(debut) == 2000) %>%
pull(playerID) -> year2000.ids
Batting %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB > 1000) %>%
pull(playerID) -> AB1000.ids
Batting %>%
filter(playerID %in% year2000.ids,
playerID %in% AB1000.ids)
Batting %>%
filter(playerID %in% year2000.ids,
playerID %in% AB1000.ids) %>%
left_join(Master %>% select(nameLast, nameFirst)) -> player.stats
Batting %>%
filter(playerID %in% year2000.ids,
playerID %in% AB1000.ids) %>%
left_join(Master %>% select(nameLast, nameFirst, playerID)) -> player.stats
source("Chapter8_functions.R")
player.ids <- interect(year2000.ids, AB1000.ids)
player.ids <- intersect(year2000.ids, AB1000.ids)
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2000.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB > 1000) %>%
pull(playerID) -> player.ids
library(Lahman)
library(tidyverse)
library(lubridate)
#Players with debut in year 2000
Master %>%
filter(year(debut) == 2000) %>%
pull(playerID) -> year2000.ids
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2000.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB > 1000) %>%
pull(playerID) -> player.ids
source("Chapter8_functions.R")
# get statistics by age
player.ids %>%
map(get_stats)
# get statistics by age
player.ids %>%
map_df(get_stats)
# get statistics by age
player.ids %>%
map_df(get_stats) -> player.stats
# get statistics by age and add names
player.ids %>%
map_df(get_stats) %>%
left_join(Master %>% select(nameLast, nameFirst, playerID))-> player.stats
player.stats
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method == "lm",
formula = x + I(x^2))
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method == "lm",
formula = y~ x + I(x^2))
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2))
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE)
library(ggrepel)
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE) +
geom_text_repel(aes(group = playerID))
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE) +
geom_text_repel(aes(label = playerID))
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE) +
geom_text_repel(aes(label = playerID, group = playerID))
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE)
Master %>%
filter(playerID %in% player.ids) %>%
select(nameFirst, nameLast) %>%
kable()
library(Lahman)
library(tidyverse)
library(lubridate)
library(ggrepel)
#Players with debut in year 2000
Master %>%
filter(year(debut) == 2000) %>%
pull(playerID) -> year2000.ids
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2000.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB > 1000) %>%
pull(playerID) -> player.ids
library(knitr)
Master %>%
filter(playerID %in% player.ids) %>%
select(nameFirst, nameLast) %>%
kable()
Master %>%
filter(year(debut) == 2001) %>%
pull(playerID) -> year2000.ids
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2000.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB > 1000) %>%
pull(playerID) -> player.ids
library(knitr)
Master %>%
filter(playerID %in% player.ids) %>%
select(nameFirst, nameLast) %>%
kable()
source("Chapter8_functions.R")
# get statistics by age and add names
player.ids %>%
map_df(get_stats) %>%
left_join(Master %>% select(nameLast, nameFirst, playerID))-> player.stats
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE)
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2001.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB), HR = sum(HR)) %>%
filter(AB > 1000) %>%
arrange(desc(HR)) %>%
pull(playerID) -> player.ids
library(Lahman)
library(tidyverse)
library(lubridate)
library(ggrepel)
#Players with debut in year 2000
Master %>%
filter(year(debut) == 2001) %>%
pull(playerID) -> year2001.ids
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2001.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB), HR = sum(HR)) %>%
filter(AB > 1000) %>%
arrange(desc(HR)) %>%
pull(playerID) -> player.ids
library(knitr)
Master %>%
filter(playerID %in% player.ids) %>%
select(nameFirst, nameLast) %>%
kable()
Master %>%
filter(year(debut) == 2001) %>%
pull(playerID) -> year2001.ids
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2001.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB), HR = sum(HR)) %>%
filter(AB > 1000) %>%
arrange(desc(HR)) %>%
pull(playerID) -> player.ids
library(knitr)
Master %>%
filter(playerID %in% player.ids) %>%
select(nameFirst, nameLast) %>%
kable()
player.ids
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2001.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB > 1000) %>%
pull(playerID) -> player.ids
library(Lahman)
library(tidyverse)
library(lubridate)
library(ggrepel)
#Players with debut in year 2000
Master %>%
filter(year(debut) == 2001) %>%
pull(playerID) -> year2001.ids
#Players with at least 1000 atbats
Batting %>%
filter(playerID %in% year2001.ids) %>%
group_by(playerID) %>%
summarize(AB = sum(AB)) %>%
filter(AB > 1000) %>%
pull(playerID) -> player.ids
library(knitr)
Master %>%
filter(playerID %in% player.ids) %>%
select(nameFirst, nameLast) %>%
kable()
library(brms)
library(rstan)
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | Player),
data = players.stats,
family = binomial("logit"))
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | Player),
data = player.stats,
family = binomial("logit"))
source("Chapter8_functions.R")
# get statistics by age and add names
player.ids %>%
map_df(get_stats) %>%
left_join(Master %>% select(nameLast, nameFirst, playerID))-> player.stats
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE)
library(brms)
library(rstan)
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | Player),
data = player.stats,
family = binomial("logit"))
player.stats
fit <- brm(OB | trials(PA) ~ (Age - 30) + I((Age - 30) ^ 2) +
((Age - 30) + I((Age - 30) ^ 2) | playerID),
data = player.stats,
family = binomial("logit"))
player.stats %>%
mutate(AgeD = Age - 30) -> player.stats
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | Player),
data = players.stats,
family = binomial("logit"))
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | Player),
data = player.stats,
family = binomial("logit"))
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | playerID),
data = player.stats,
family = binomial("logit"))
player.stats %>%
mutate(AgeD = Age - 30,
Player = paste(nameFirst,nameLast, sep = " ")) -> player.stats
fit <- brm(OB | trials(PA) ~ AgeD + I(AgeD ^ 2) +
(AgeD + I(AgeD ^ 2) | Player),
data = player.stats,
family = binomial("logit"))
Player_Fits <- coef(fit)$Player[, "Estimate", ] %>%
as_tibble(rownames = "Player") %>%
rename(b0.hat = Intercept,
b1.hat = AgeD,
b2.hat = IAgeDE2)
player.stats <- inner_join(player.stats, Player_Fits, by = "Player")
# find estimates of OBP probs at each age
# note plogis is the logit function
player.stats %>%
mutate(OBP.pred = plogis(b0.hat + b1.hat * AgeD + b2.hat * AgeD^2)) -> player.stats
player.stats %>%
ggplot(aes(x = Age + 30,
y = OBP.pred,
group = Player)) +
geom_line()
player.stats %>%
ggplot(aes(x = Age + 30,
y = OBP.pred,
group = Player)) +
geom_line(color = "red")
player.stats %>%
ggplot(aes(x = Age,
y = OBP.pred,
group = Player)) +
geom_line(color = "red")
player.stats
player.stats %>% group_by(Player) %>%
summarize(B0 = first(B0),
B1 = first(B1),
B2 = first(B2),
b0 = first(Intercept),
b1 = first(AgeD.y),
b2 = first(IAgeDE2)) %>%
mutate(Ind_Peak_Age = 30 - B1 / 2 / B2,
MLM_Peak_Age = 30 - b1 / 2 / b2)  %>%
select(Ind_Peak_Age, MLM_Peak_Age) %>%
pivot_longer(everything(),
names_to = "Type",
values_to = "Age") -> S
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE)
player.stats %>%
split(pull(.,playerID)) %>%
map(fit_model)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OPS)) %>%
geom_smooth(method = "lm",
formula = y ~ x + I(x^2))
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OPS)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2))
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OPS)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OPS)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OPS)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE) +
ylim(0,1)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OPS)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OBP)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OBP)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE) +
ylim(0,1)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OBP)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE) +
ylim(0,1) + xlim(20,40)
#plot trajectories
player.stats %>%
ggplot(aes(x = Age, y = OBP, group = playerID)) +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2),
se = FALSE)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OBP)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE) +
ylim(0.2,0.5) + xlim(20,40)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OBP)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE) +
ylim(0,0.5) + xlim(20,40)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OBP)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE) +
ylim(0,1) + xlim(20,40)
player.stats %>%
filter(playerID == "custja01") %>%
ggplot(aes(x = Age, y = OBP)) +
geom_point() +
geom_smooth(method = "lm",
formula = y ~ x + I(x^2), se = FALSE) +
ylim(0,1) + xlim(20,40) +
geom_line(aes(y = OBP.pred), color = "red")
# Extract the player's debut year
library(Lahman)
library(tidyverse)
Master %>%
head(5)
library(lubridate)
Master %>%
filter(debut >= 1940 & debut <= 1945)
Master %>%
filter(year(debut) <= 1945, year(debut) >= 1940)
library(Lahman)
library(tidyverse)
Master %>%
head(5)
library(lubridate)
Master %>%
filter(year(debut) >= 1940, year(debut) <= 1945)
Master %>%
filter(playerID %>% "custja01")
Master %>%
filter(playerID == "custja01")
library(tidyverse)
library(Lahman)
source("Chapter8_functions.R")
Batting %>%
inner_join(Master, by = "playerID") %>%
group_by(playerID) %>%
filter(debut >= "1940-01-01") %>%
filter(debut <= "1945-12-31") %>%
group_by(playerID) %>%
summarize(N = n(), totalAB = sum(AB)) %>%
filter(totalAB >= 2000) %>%
arrange(desc(totalAB)) %>%
select(playerID) -> twothousandold
Batting %>%
inner_join(Master, by = "playerID") %>%
group_by(playerID) %>%
filter(debut >= "1970-01-01") %>%
filter(debut <= "1975-12-31") %>%
group_by(playerID) %>%
summarize(N = n(), totalAB = sum(AB)) %>%
filter(totalAB >= 2000) %>%
arrange(desc(totalAB)) %>%
select(playerID) -> twothousandnew
twothousandold %>%
map_df(get_stats) -> player.statsold
player.statsold
Batting %>%
inner_join(Master, by = "playerID") %>%
group_by(playerID) %>%
filter(debut >= "1940-01-01") %>%
filter(debut <= "1945-12-31") %>%
group_by(playerID) %>%
summarize(N = n(), totalAB = sum(AB)) %>%
filter(totalAB >= 2000) %>%
arrange(desc(totalAB)) %>%
pull(playerID) -> twothousandold
twothousandold %>%
map_df(get_stats) -> player.statsold
player.statsold
Batting %>%
inner_join(Master, by = "playerID") %>%
group_by(playerID) %>%
filter(debut >= "1970-01-01") %>%
filter(debut <= "1975-12-31") %>%
group_by(playerID) %>%
summarize(N = n(), totalAB = sum(AB)) %>%
filter(totalAB >= 2000) %>%
arrange(desc(totalAB)) %>%
pull(playerID) -> twothousandnew
twothousandnew %>%
map_df(get_stats) -> player.statsnew
library(Lahman)
library(tidyverse)
Batting %>%
group_by(playerID) %>%
summarize(H = sum(H)) %>%
filter(H > 3200)
Batting %>%
group_by(playerID) %>%
inner_join(Master, by = "playerID")
source("Chapter8_functions.R")
